# -*- coding: utf-8 -*-
"""crawling_AWS.ipynb

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/1gJqON5x0HIrucvGK8RcItWwM46i7xJFu
"""

import tweepy
import pandas as pd
import re
import datetime
import os
from emoji import demojize

#저장위치
if "twitter_data" not in os.listdir():
  os.mkdir("twitter_data")
os.chdir("twitter_data")
os.listdir()

# 트위터 API에 접근하기 위한 개인 키를 입력
with open("dev_keys.txt","r") as f:
  bearer_token = f.readline().split()[-1][1:-1]

# OAuth 핸들러 생성 & 개인정보 인증 요청
auth = tweepy.OAuth2BearerHandler(bearer_token)

# api instace 생성
api = tweepy.API(auth, wait_on_rate_limit = True)

# 현재시간 구하기 + 값 출력하기
def get_today():
    global today
    today = datetime.datetime.now()

# 검색할 이모지 dictionary 정의
search_form = " -filter:retweets"
# keyword = input("키워드를 입력하거라...")

# 하루당 가져올 트윗 개수 지정(한 request 당 count개, 총 num_tweets 개.)
count = 100
num_tweets = 4000 # request 한도인 450 request까지 요청 가능, 총 45,000개 트윗

#가져올 날짜 수 지정
days = 10

#가져올 이모지 개수 지정
num_emojis = 30

# 날짜 설정해주기
get_today()
dash = "-"
blank = ""

#https://www.makeuseof.com/top-emojis-explained-cheat-sheet/ 22.07.27
emoji_list = "😂❤️🤣👍😭🙏😘🥰😍😊🎉😁💕🥺😅🔥☺️🤦♥️🤷🙄😆🤗😉🎂🤔👏🙂😳🥳😎👌💜😔💪✨💖👀😋😏😢👉💗😩💯🌹💞🎈💙😃😡💐😜🙈🤞😄🤤🙌🤪❣️😀💋💀👇💔😌💓🤩🙃😬😱😴🤭😐🌞😒😇🌸😈🎶✌️🎊🥵😞💚☀️🖤💰😚👑🎁💥🙋☹️😑🥴👈💩✅"

emoji_list = [emoji for emoji in emoji_list if emoji != chr(65039)]

name_list = [demojize(emo) for emo in emoji_list]

emoji_to_name = dict(zip(emoji_list,name_list))
print(emoji_to_name)

print(len(name_list), len(emoji_list))

from git import Repo

PATH_OF_GIT_REPO = "~/emoji_recomm/twitter_data"  # make sure .git folder is properly configured
COMMIT_MESSAGE = "from AWS in " + str(today)

repo = Repo(PATH_OF_GIT_REPO)
origin = repo.remote(name='origin')

def git_push():
      repo.git.add(update=True)
      repo.index.commit(COMMIT_MESSAGE)
      repo.git.push("--set-upstream", origin, repo.head.ref)

git_push()

cnt = 0

for emoji, name in emoji_to_name.items():
    if cnt == num_emojis :
      break
    cnt+=1
    
    df_list = []

    keyword = emoji + search_form
    print(emoji)
    for n in range(days):
        date = today - datetime.timedelta(days = n) # n일 전
        date = date.strftime(f"%Y{dash}%m{dash}%d{blank}").strip()

        tweets = tweepy.Cursor(api.search_tweets, q = keyword, result_type = "past",
                                    until = date, lang = "ko", count = count).items(num_tweets)
        data = {}
        tweet_set = set() # 중복 제거용 집합 생성

        for tweet in tweets:
            tweet = tweet.text
            tweet = re.sub('[-=+,#/\?:^.@*\"※~ㆍ!』‘|\(\)\[\]`\'…》\”\“\’·/&]', '', tweet)
            tweet = re.sub('[A-z]', '', tweet)
            tweet = re.sub('[\n]', ' ', tweet)
            tweet = tweet.strip()
            #print(tweet)
            tweet_set.add(tweet)

        tweet_list = list(tweet_set)
        index = list(range(len(tweet_list)))
        data["tweet"] = tweet_list
        df = pd.DataFrame(data)
        df_list.append(df)
        
        print(date, df.shape, api.rate_limit_status()['resources']['search']['/search/tweets'])
    
        file_name = name[1:-1] + (today - datetime.timedelta(days = n)).strftime("_%m-%d") +".csv"
        df = pd.concat(df_list)
        df.to_csv(file_name, mode='w')

        git_push()

        print(file_name, "pushed")

for n in range(num_emojis):
  file_name = name_list[n][1:-1] + ".csv"
  df = pd.read_csv(file_name, encoding = 'utf-8')
  print(df)