# -*- coding: utf-8 -*-
"""crawling_AWS.ipynb

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/1gJqON5x0HIrucvGK8RcItWwM46i7xJFu
"""

import tweepy
import pandas as pd
import re
import datetime
import os
from emoji import demojize

#ì €ì¥ìœ„ì¹˜
if "twitter_data" not in os.listdir():
  os.mkdir("twitter_data")
os.chdir("twitter_data")
os.listdir()

# íŠ¸ìœ„í„° APIì— ì ‘ê·¼í•˜ê¸° ìœ„í•œ ê°œì¸ í‚¤ë¥¼ ì…ë ¥
with open("dev_keys.txt","r") as f:
  consumer_key = f.readline().split()[-1][1:-1]
  consumer_secret = f.readline().split()[-1][1:-1]
  access_token = f.readline().split()[-1][1:-1]
  access_token_secret = f.readline().split()[-1][1:-1]

# OAuth í•¸ë“¤ëŸ¬ ìƒì„± & ê°œì¸ì •ë³´ ì¸ì¦ ìš”ì²­
auth = tweepy.OAuthHandler(consumer_key, consumer_secret)

# ì•¡ì„¸ìŠ¤ ìš”ì²­
auth.set_access_token(access_token, access_token_secret)

# api instace ìƒì„±
api = tweepy.API(auth)

# í˜„ì¬ì‹œê°„ êµ¬í•˜ê¸° + ê°’ ì¶œë ¥í•˜ê¸°
def get_today():
    global today
    today = datetime.datetime.now()

# ê²€ìƒ‰í•  ì´ëª¨ì§€ dictionary ì •ì˜
search_form = " -filter:retweets"
# keyword = input("í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ê±°ë¼...")

# ê°€ì ¸ì˜¬ íŠ¸ìœ— ê°œìˆ˜ ì§€ì •(ìµœëŒ€ 100ê°œ, DefaultëŠ” 15ê°œ)
count = 100

#ê°€ì ¸ì˜¬ ë‚ ì§œ ìˆ˜ ì§€ì •
days = 10

#ê°€ì ¸ì˜¬ ì´ëª¨ì§€ ê°œìˆ˜ ì§€ì •
num_emojis = 99
    
# ë‚ ì§œ ì„¤ì •í•´ì£¼ê¸°e
get_today()
dash = "-"
blank = ""

#https://www.makeuseof.com/top-emojis-explained-cheat-sheet/ 22.07.27
emoji_list = "ğŸ˜‚â¤ï¸ğŸ¤£ğŸ‘ğŸ˜­ğŸ™ğŸ˜˜ğŸ¥°ğŸ˜ğŸ˜ŠğŸ‰ğŸ˜ğŸ’•ğŸ¥ºğŸ˜…ğŸ”¥â˜ºï¸ğŸ¤¦â™¥ï¸ğŸ¤·ğŸ™„ğŸ˜†ğŸ¤—ğŸ˜‰ğŸ‚ğŸ¤”ğŸ‘ğŸ™‚ğŸ˜³ğŸ¥³ğŸ˜ğŸ‘ŒğŸ’œğŸ˜”ğŸ’ªâœ¨ğŸ’–ğŸ‘€ğŸ˜‹ğŸ˜ğŸ˜¢ğŸ‘‰ğŸ’—ğŸ˜©ğŸ’¯ğŸŒ¹ğŸ’ğŸˆğŸ’™ğŸ˜ƒğŸ˜¡ğŸ’ğŸ˜œğŸ™ˆğŸ¤ğŸ˜„ğŸ¤¤ğŸ™ŒğŸ¤ªâ£ï¸ğŸ˜€ğŸ’‹ğŸ’€ğŸ‘‡ğŸ’”ğŸ˜ŒğŸ’“ğŸ¤©ğŸ™ƒğŸ˜¬ğŸ˜±ğŸ˜´ğŸ¤­ğŸ˜ğŸŒğŸ˜’ğŸ˜‡ğŸŒ¸ğŸ˜ˆğŸ¶âœŒï¸ğŸŠğŸ¥µğŸ˜ğŸ’šâ˜€ï¸ğŸ–¤ğŸ’°ğŸ˜šğŸ‘‘ğŸğŸ’¥ğŸ™‹â˜¹ï¸ğŸ˜‘ğŸ¥´ğŸ‘ˆğŸ’©âœ…"

emoji_list = [emoji for emoji in emoji_list if emoji != chr(65039)]

name_list = [demojize(emo) for emo in emoji_list]

emoji_to_name = dict(zip(emoji_list,name_list))
print(emoji_to_name)

print(len(name_list), len(emoji_list))

cnt = 0

for emoji, name in emoji_to_name.items():
    if cnt == num_emojis :
      break
    cnt+=1
    
    df_list = []

    keyword = emoji + search_form
    print(emoji)
    for n in range(days):
        date = today - datetime.timedelta(days = n) # nì¼ ì „
        date = date.strftime(f"%Y{dash}%m{dash}%d{blank}").strip()

        tweets = api.search(q = keyword, result_type = "past", until = date, lang = "ko", count = count)
        data = {}
        tweet_set = set() # ì¤‘ë³µ ì œê±°ìš© ì§‘í•© ìƒì„±

        for tweet in tweets:
            tweet = tweet.text
            tweet = re.sub('[-=+,#/\?:^.@*\"â€»~ã†!ã€â€˜|\(\)\[\]`\'â€¦ã€‹\â€\â€œ\â€™Â·/&]', '', tweet)
            tweet = re.sub('[A-z]', '', tweet)
            tweet = re.sub('[\n]', ' ', tweet)
            tweet = tweet.strip()
            #print(tweet)
            tweet_set.add(tweet)

        tweet_list = list(tweet_set)
        index = list(range(len(tweet_list)))
        data["tweet"] = tweet_list
        df = pd.DataFrame(data)
        df_list.append(df)
        
        print(date, df.shape, api.rate_limit_status()['resources']['search']['/search/tweets'])
    
    file_name = name[1:-1] +".csv"
    df = pd.concat(df_list)
    df.to_csv(file_name, mode='w')

for n in range(num_emojis):
  file_name = name_list[n][1:-1] + ".csv"
  df = pd.read_csv(file_name, encoding = 'utf-8')
  print(df)